name: Pull Request Management

on:
    pull_request:
        types: [opened, synchronize, reopened, labeled, ready_for_review]
    pull_request_review:
        types: [submitted]

permissions:
    contents: write
    pull-requests: write
    checks: write

jobs:
    auto-label-pr:
        name: Auto Label PR
        runs-on: ubuntu-latest
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
        steps:
            - name: Checkout code
              uses: actions/checkout@v6

            - name: Label PR
              uses: actions/labeler@v6
              with:
                  repo-token: ${{ secrets.PAT_TOKEN }}
                  configuration-path: .github/labeler.yml
                  sync-labels: true

    greet-first-pr:
        name: Greet First-Time Contributors
        runs-on: ubuntu-latest
        if: github.event_name == 'pull_request' && github.event.action == 'opened'
        steps:
            - name: Check if first PR
              uses: actions/github-script@v8
              with:
                  script: |
                      const pr = context.payload.pull_request;
                      const author = pr.user.login;

                      const { data: prs } = await github.rest.pulls.list({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        state: 'all',
                        creator: author
                      });

                      if (prs.length === 1) {
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: pr.number,
                          body: `## ðŸŽ‰ First Pull Request!

                      Welcome @${author}! Thank you for your first contribution to Liora!

                      ### What happens next?

                      1. **Automated Checks**: Our CI/CD pipeline will run automated tests and checks
                      2. **Code Review**: A maintainer will review your changes
                      3. **Feedback**: We may request changes or ask questions
                      4. **Merge**: Once approved, your PR will be merged!

                      ### ðŸ“š Helpful Tips

                      - Make sure all CI checks pass (green âœ…)
                      - Respond to review comments
                      - Keep your branch up to date with \`main\`
                      - Feel free to ask questions!

                      ### ðŸ“– Resources

                      - [Contributing Guidelines](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CONTRIBUTING.md)
                      - [Code of Conduct](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CODE_OF_CONDUCT.md)

                      Thank you for contributing! We're excited to review your work! ðŸš€`
                        });
                      }

    auto-approve-dependabot:
        name: Auto Approve Dependabot
        runs-on: ubuntu-latest
        if: |
            github.event_name == 'pull_request' && 
            github.actor == 'dependabot[bot]' &&
            (github.event.action == 'opened' || github.event.action == 'synchronize')
        steps:
            - name: Dependabot metadata
              id: metadata
              uses: dependabot/fetch-metadata@v2
              with:
                  github-token: ${{ secrets.PAT_TOKEN }}

            - name: Auto approve minor/patch updates
              if: |
                  steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
                  steps.metadata.outputs.update-type == 'version-update:semver-minor'
              run: |
                  gh pr review --approve "${{ github.event.pull_request.html_url }}" \
                    --body "âœ… Auto-approved: ${{ steps.metadata.outputs.update-type }} dependency update"
              env:
                  GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

            - name: Enable auto-merge
              if: |
                  steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
                  steps.metadata.outputs.update-type == 'version-update:semver-minor'
              run: gh pr merge --auto --squash "${{ github.event.pull_request.html_url }}"
              env:
                  GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}

    check-ci-status:
        name: Check CI Status
        runs-on: ubuntu-latest
        if: |
            github.event_name == 'pull_request' && 
            github.event.action == 'labeled' &&
            github.event.label.name == 'ready-to-merge'
        steps:
            - name: Verify all checks passed
              uses: actions/github-script@v8
              with:
                  script: |
                      const pr = context.payload.pull_request;

                      const { data: checkRuns } = await github.rest.checks.listForRef({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        ref: pr.head.sha
                      });

                      const { data: statuses } = await github.rest.repos.getCombinedStatusForRef({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        ref: pr.head.sha
                      });

                      const failedChecks = checkRuns.check_runs.filter(
                        check => check.conclusion !== 'success' && check.conclusion !== 'neutral'
                      );

                      if (failedChecks.length > 0 || statuses.state !== 'success') {
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: pr.number,
                          body: `## âš ï¸ Cannot Merge: CI Checks Failed

                      This PR is labeled as "ready-to-merge" but some CI checks have failed.

                      Please ensure all checks pass before merging:
                      - âœ… All automated tests
                      - âœ… Code quality checks
                      - âœ… Security scans

                      Failed checks: ${failedChecks.map(c => c.name).join(', ') || 'Status checks'}

                      Fix the issues and push new changes to update the checks.`
                        });
                        
                        core.setFailed('CI checks have not all passed');
                      }
